================================================================================
ComfyUI 自定义节点 (Custom Node) 开发指南 [2026版]
================================================================================
来源：ComfyUI 官方文档 & 社区最新最佳实践
整理时间：2026年2月
适用版本：ComfyUI v0.3+ (及兼容版本)

目录
--------------------------------------------------------------------------------
1. 概述与目录结构
2. 核心：定义一个 Python 节点
3. 进阶：数据类型与处理逻辑
4. 进阶：前端扩展 (Javascript)
5. 最佳实践与发布规范
6. 实战案例：创建一个简单的图像处理节点
--------------------------------------------------------------------------------

1. 概述与目录结构
================================================================================
ComfyUI 的扩展性极强，所有自定义节点都存放在 `ComfyUI/custom_nodes/` 目录下。
ComfyUI 在启动时会扫描该目录下的子文件夹，并加载其中的 `__init__.py` 文件。

推荐的文件结构：
ComfyUI/
    custom_nodes/
        ComfyUI-MyExtension/       <-- 你的项目文件夹
            __init__.py              <-- 入口文件 (必须)
            nodes/                   <-- 节点逻辑实现 (核心)
                node.py
            requirements.txt         <-- 依赖包列表 (可选，但推荐)
            README.md                <-- 说明文档
            web/                      <-- (可选) 存放前端 .js 扩展
                my_script.js

--------------------------------------------------------------------------------

2. 核心：定义一个 Python 节点
================================================================================
一个标准的节点就是一个 Python 类 (Class)。该类必须包含以下 4 个核心属性和一个执行函数。

2.1 必要属性
------------
1. INPUT_TYPES (classmethod): 
   定义输入端口。必须返回一个字典，包含 "required" (必须)、"optional" (可选) 和 "hidden" (隐藏) 字段。

2. RETURN_TYPES (tuple): 
   定义输出端口的数据类型。例如 `("IMAGE", "STRING")`。

3. RETURN_NAMES (tuple, 可选): 
   定义输出端口在 UI 上显示的名称。若省略，默认显示类型名称。

4. FUNCTION (str): 
   定义执行处理逻辑的函数名。例如 `"process_image"`。

5. CATEGORY (str): 
   定义节点在右键菜单中的分类路径。例如 `"MyNodes/Image"`。

2.2 示例代码结构
----------------
class MySimpleNode:
    def __init__(self):
        pass

    @classmethod
    def INPUT_TYPES(s):
        return {
            "required": {
                "image": ("IMAGE",),  # 输入类型为图片
                "int_val": ("INT", {
                    "default": 10, 
                    "min": 0, 
                    "max": 100, 
                    "step": 1,
                    "display": "number" 
                }),
            }
        }

    RETURN_TYPES = ("IMAGE",)
    FUNCTION = "do_work"
    CATEGORY = "Example"

    def do_work(self, image, int_val):
        # 在这里写处理逻辑
        return (image,)

--------------------------------------------------------------------------------

3. 进阶：数据类型与处理逻辑
================================================================================

3.1 常见数据类型 (Types)
------------------------
ComfyUI 使用特定的约定来传递数据：
- IMAGE: 图片张量 (Tensor)。格式为 [Batch, Height, Width, Channel]。
         数值范围通常是 0.0 到 1.0 (float32)。
         注意：PyTorch 默认是 BCHW，但 ComfyUI 使用 BHWC。
- MASK:  遮罩张量。格式为 [Batch, Height, Width]。范围 0.0 到 1.0。
- LATENT: 潜空间数据 (字典格式，包含 "samples" 等键)。
- MODEL / CLIP / VAE: 模型加载器传递的对象。
- STRING / INT / FLOAT: 基础数据类型。

3.2 控件配置 (Widget Config)
----------------------------
在 INPUT_TYPES 中可以配置 UI 控件的行为：
- "INT": {"default": 1, "min": 0, "max": 10}
- "FLOAT": {"default": 1.0, "min": 0.0, "max": 10.0, "step": 0.01}
- "STRING": {"multiline": True}  <-- 多行文本框
- ["option1", "option2"]:        <-- 下拉菜单 (List)

3.3 执行流程与缓存 (Caching)
----------------------------
ComfyUI 默认会缓存节点执行结果。如果输入参数没有变化，`FUNCTION` 不会被重新调用。
- 如果你的节点涉及随机数，需要添加输入 `"seed": ("INT", {"default": 0, "min": 0, "max": 0xffffffffffffffff})`。
- 或者定义 `IS_CHANGED` 方法来强制刷新：
    @classmethod
    def IS_CHANGED(s, image, int_val):
        return float("nan") # 总是重新执行

--------------------------------------------------------------------------------

4. 进阶：前端扩展 (Javascript)
================================================================================
如果需要修改 UI 行为（例如：节点上的动态显示、隐藏部件、右键菜单增强），需要在 `js/` 目录下编写 Javascript 文件。

- 只要在节点根目录下创建 `js` 文件夹，ComfyUI 启动时会自动加载其中的 .js 文件。
- 前端扩展通常通过 `app.registerExtension` 进行注册。

示例 (js/my_script.js):
app.registerExtension({
    name: "My.Extension",
    async nodeCreated(node, app) {
        if (node.comfyClass === "MySimpleNode") {
            // 对特定节点进行 UI 修改
        }
    }
});

--------------------------------------------------------------------------------

5. 最佳实践与发布规范
================================================================================

5.1 注册节点 (__init__.py)
--------------------------
在 `__init__.py` 中，你需要映射类名到 ComfyUI 的内部名称和显示名称。

from .my_node import MySimpleNode

NODE_CLASS_MAPPINGS = {
    "MySimpleNode": MySimpleNode
}

NODE_DISPLAY_NAME_MAPPINGS = {
    "MySimpleNode": "My First Custom Node"
}

__all__ = ["NODE_CLASS_MAPPINGS", "NODE_DISPLAY_NAME_MAPPINGS"]

5.2 命名规范
------------
- 类名：使用驼峰命名法 (CamelCase)。
- CATEGORY：尽量使用你的项目名作为一级目录，避免污染根目录。例如 "ComfyUI-MyExtension/Utils" 而不是直接 "Utils"。
- 输入参数名：尽量简短且具描述性。

5.3 兼容性提示 (2026年更新)
---------------------------
- 张量形状：始终检查输入图片的 shape。确保处理 Batch 维度。
- 类型安全：如果输入可能是多种类型，可以使用 `*` 通配符 (ComfyUI 近期特性)，但在函数内部要做好类型检查。

--------------------------------------------------------------------------------

6. 实战案例：图像反转节点 (Invert Image)
================================================================================
以下是一个完整的、可运行的 Python 文件示例。

文件名: nodes.py
--------------------------------------------------------------------------------
import torch

class InvertImageNode:
    """
    一个简单的节点，将输入图片颜色反转 (1 - pixel_value)。
    支持 Batch 处理。
    """
    def __init__(self):
        pass

    @classmethod
    def INPUT_TYPES(s):
        return {
            "required": {
                "image": ("IMAGE",),  # 输入: [B, H, W, C]
            },
            "optional": {
                "strength": ("FLOAT", {
                    "default": 1.0, 
                    "min": 0.0, 
                    "max": 1.0, 
                    "step": 0.01
                }),
            }
        }

    RETURN_TYPES = ("IMAGE",)
    RETURN_NAMES = ("inverted_image",)
    FUNCTION = "invert"
    CATEGORY = "MyTutorial/Image"

    def invert(self, image, strength):
        # image 是 PyTorch Tensor, 范围 0-1
        # 逻辑: result = image * (1-strength) + (1-image) * strength
        
        inverted = 1.0 - image
        
        # 线性插值混合原图和反转图
        result = image * (1.0 - strength) + inverted * strength
        
        # 确保范围在 0-1 之间 (虽然数学上不会越界，但这是好习惯)
        result = torch.clamp(result, 0.0, 1.0)
        
        return (result,)

# ------------------------------------------------------------------------------
# 文件名: __init__.py
# ------------------------------------------------------------------------------
# from .nodes import InvertImageNode
#
# NODE_CLASS_MAPPINGS = {
#     "InvertImageNode": InvertImageNode
# }
#
# NODE_DISPLAY_NAME_MAPPINGS = {
#     "InvertImageNode": "Simple Image Invert"
# }
#
# __all__ = ["NODE_CLASS_MAPPINGS", "NODE_DISPLAY_NAME_MAPPINGS"]

================================================================================
文档结束
================================================================================